#--------------------
#DISCOS
#--------------------
pvcreate /dev/sdb
vgcreate -n data /dev/sdb
lvcreate -n mysql -L 20G data
lvcreate -n vhosts -l  data   #(tamanho total disponivel de vgdisplay data)
mkfs.xfs /dev/data/vhosts
mkfs.xfs /dev/data/mysql

mkdir -p /var/www/vhosts
mkdir -p /var/lib/mysql

echo "/dev/data/vhosts				/var/www/vhosts		xfs	defaults	0 0" >> /etc/fatab
echo "/dev/data/mysql				/var/lib/mysql		xfs	defaults	0 0" >> /etc/fatab

#--------------------
# BASE
#--------------------
yum update -y 
yum upgrade -y
dnf -y install epel-release
yum update -y 
yum install glibc-langpack-en glibc-langpack-pt git vim wget net-tools htop iftop iotop nload nmon nethogs ntfs-3g  sshfs parted net-tools ethtool expect -y
echo 'LANG="pt_BR.utf8"' > /etc/locale.conf 

#Desativa segurança
sed -i 's/enforcing/disabled/g' /etc/selinux/config
setenforce 0
systemctl stop firewalld ; systemctl disable firewalld

#Agent Proxmox
dnf install qemu-guest-agent -y
systemctl enable --now  qemu-guest-agent 

#Instalar PHP83
Versao=83
VRemi="8.3"
sudo dnf install -y https://rpms.remirepo.net/enterprise/remi-release-9.rpm
sudo dnf module reset php -y
sudo dnf module enable php:remi-${VRemi}-y
# Instalar o PHP 8.3 e os módulos especificados
sudo dnf install -y php
sudo dnf install -y php-bz2
sudo dnf install -y php-calendar 
sudo dnf install -y php-cli 
sudo dnf install -y php-ctype 
sudo dnf install -y php-curl 
sudo dnf install -y php-date 
sudo dnf install -y php-devel 
sudo dnf install -y php-dom 
sudo dnf install -y php-exif
sudo dnf install -y php-fileinfo
sudo dnf install -y php-filter 
sudo dnf install -y php-ftp 
sudo dnf install -y php-gd
sudo dnf install -y php-gettext
sudo dnf install -y php-hash
sudo dnf install -y php-iconv
sudo dnf install -y php-intl
sudo dnf install -y php-json
sudo dnf install -y php-libxml
sudo dnf install -y php-mbstring
sudo dnf install -y php-mysqli
sudo dnf install -y php-mysqlnd
sudo dnf install -y php-openssl
sudo dnf install -y php-pcntl
sudo dnf install -y php-pcre
sudo dnf install -y php-pear
sudo dnf install -y php-pdo
sudo dnf install -y php-pdo_mysql
sudo dnf install -y php-pdo_sqlite
sudo dnf install -y php-readline
sudo dnf install -y php-session
sudo dnf install -y php-sockets
sudo dnf install -y php-sqlite3
sudo dnf install -y php-tokenizer
sudo dnf install -y php-xml
sudo dnf install -y php-xmlreader
sudo dnf install -y php-xmlwriter
sudo dnf install -y php-xsl
sudo dnf install -y php-zip
sudo dnf install -y php-zlib
sudo dnf install -y php-mcrypt
sudo dnf install -y php-mysqlnd
sudo dnf install -y php-jsonlint.noarch 
sudo dnf install -y php${Versao}*-imap*
sudo dnf install -y php${Versao}-php-gd 
sudo dnf install -y php${Versao}-php-zip 
sudo dnf install -y php${Versao}-php*imagick-im7*
sudo dnf install -y php-jsonlint.noarch
sudo dnf install -y php${Versao}-php-gd 
sudo dnf install -y php${Versao}-php-zip  
sudo dnf install -y php${Versao}*-*xmlrpc*
no "n" | sudo pecl install apcu
sudo pecl install simdjson
echo "extension=apcu.so" | sudo tee /etc/php.d/40-apcu.ini

sudo systemctl restart php-fpm

#Instalar MySQL
sudo rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2023
sudo dnf install -y https://dev.mysql.com/get/mysql80-community-release-el9-1.noarch.rpm
sudo dnf install -y mysql-community-server
sudo systemctl enable --now mysqld

#Configura SQL
NEW_ROOT_PASSWORD="1QF*Mgcsx&Mt@#" 
DB_MYSQL="wp-creamy"
USER_MYSQL=wp-creamy
PASS_MYSQL=kv7AfEzX5AVhF

# Extrair a senha temporária do usuário root
ROOT_PASSWORD=$(sudo grep 'temporary password' /var/log/mysqld.log | awk '{print $NF}')
# Definir uma nova senha segura para o usuário root

cat $NEW_ROOT_PASSWORD > /root/mysqlpass.txt
mysql --connect-expired-password -u root -p"$ROOT_PASSWORD" <<EOF
ALTER USER 'root'@'localhost' IDENTIFIED BY '$NEW_ROOT_PASSWORD';
CREATE DATABASE ${DB_MYSQL};
CREATE USER '${USER_MYSQL}'@'%' IDENTIFIED BY '${PASS_MYSQL}'; 
GRANT ALL PRIVILEGES ON wordpress.* TO '${USER_MYSQL}'@'%';
FLUSH PRIVILEGES;
EXIT
EOF


