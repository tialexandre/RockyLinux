#--------------------
#DISCOS
#--------------------
pvcreate /dev/sdb
vgcreate -n data /dev/sdb
lvcreate -n mysql -L 20G data
lvcreate -n vhosts -l  data   #(tamanho total disponivel de vgdisplay data)
mkfs.xfs /dev/data/vhosts
mkfs.xfs /dev/data/mysql

mkdir -p /var/www/vhosts
mkdir -p /var/lib/mysql

echo "/dev/data/vhosts				/var/www/vhosts		xfs	defaults	0 0" >> /etc/fatab
echo "/dev/data/mysql				/var/lib/mysql		xfs	defaults	0 0" >> /etc/fatab

#--------------------
# BASE
#--------------------
yum update -y 
yum upgrade -y
dnf -y install epel-release
yum update -y 
yum install glibc-langpack-en glibc-langpack-pt git vim wget net-tools htop iftop iotop nload nmon nethogs ntfs-3g  sshfs parted net-tools ethtool -y
echo 'LANG="pt_BR.utf8"' > /etc/locale.conf 

#Desativa segurança
sed -i 's/enforcing/disabled/g' /etc/selinux/config
setenforce 0
systemctl stop firewalld ; systemctl disable firewalld

#Agent Proxmox
dnf install qemu-guest-agent -y
systemctl enable --now  qemu-guest-agent 

#Instalar PHP83
Versao=83
VRemi="8.3"
sudo dnf install -y https://rpms.remirepo.net/enterprise/remi-release-9.rpm
sudo dnf module reset php -y
sudo dnf module enable php:remi-${VRemi}-y
# Instalar o PHP 8.3 e os módulos especificados
sudo dnf install -y php php-bz2 php-calendar php-cli php-ctype php-curl php-date php-devel php-dom php-exif \
php-fileinfo php-filter php-ftp php-gd php-gettext php-hash php-iconv php-imap php-intl php-json php-libxml \
php-mbstring php-mysqli php-mysqlnd php-openssl php-pcntl php-pcre php-pear php-pdo php-pdo_mysql \
php-pdo_sqlite php-readline php-session php-sockets php-sqlite3 php-tokenizer php-xml php-xmlreader \
php-xmlwriter php-xsl php-zip php-zlib php-mcrypt php-mysqlnd
no "n" | sudo pecl install apcu
sudo pecl install simdjson
sudo dnf install -y php-jsonlint.noarch php${Versao}-php-gd php${Versao}-php-zip php${Versao}-php-pecl-imagick-im7.x86_64 php-jsonlint.noarch php${Versao}-php-gd php${Versao}-php-zip  
sudo dnf install -y php-xmlrpc
echo "extension=apcu.so" | sudo tee /etc/php.d/40-apcu.ini

sudo systemctl restart php-fpm

#Instalar MySQL
sudo rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2023
sudo dnf install -y https://dev.mysql.com/get/mysql80-community-release-el9-1.noarch.rpm
sudo dnf install -y mysql-community-server
sudo systemctl enable --now mysqld
